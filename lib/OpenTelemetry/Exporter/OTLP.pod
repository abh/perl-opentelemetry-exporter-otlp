=encoding UTF-8

=head1 NAME

OpenTelemetry::Exporter::OTLP - An OpenTelemetry Protocol span exporter

=head1 SYNOPSIS

    ...

=head1 DESCRIPTION

This module provides a subclass of L<OpenTelemetry::Exporter> which will
export telemetry data using the OpenTelemetry Protocol (OTLP). It is the
default exporter used by L<OpenTelemetry::SDK>, and can be used to export
data either using plain JSON strings, or binary protocol buffer blobs. See
below for details.

=head1 METHODS

This class implements the L<OpenTelemetry::Exporter> role. Please consult
that module's documentation for details on the behaviours it provides.

=head2 new

    $exporter = OpenTelemetry::Exporter::OTLP->new(
        compression => $compression, # optional
        protocol    => $protocol,    # optional
    );

Constructs a new instance of the exporter. It takes the following named
parameters, both of which are optional:

=over

=item compression

Controls if and how the exported data will be compressed before sending
out. Possible values are "none", in which case no compression will be
done, and "gzip", in which case that compression algorithm will be used.

If not set, the default value will be read from the
L<"OTEL_EXPORTER_OTLP_TRACES_COMPRESSION"|OpenTelemetry::SDK/OTEL_EXPORTER_OTLP_TRACES_COMPRESSION>
environment variable, or
L<"OTEL_EXPORTER_OTLP_COMPRESSION"|OpenTelemetry::SDK/OTEL_EXPORTER_OTLP_COMPRESSION>
if the first one is not set.

If none of these values is set, the default will depend on availability.
If L<Compress::Zlib> is installed, the compression will default to "gzip",
otherwise none will be used.

If the value is set to a value other than the ones laid out above,
construction will throw an L<OpenTelemetry::X::Unsupported> exception.

=item protocol

OTLP supports multiple protocols. This exporter currently supports only
"http/json", which exports data as a JSON string over HTTP, and
"http/protobuf", which exports it as a Protobuf-encoded binary blob.

This parameter can be set to either of them to control which encoding
to use. If not set, the default value will be read from the
L<"OTEL_EXPORTER_OTLP_PROTOCOL"|OpenTelemetry::SDK/OTEL_EXPORTER_OTLP_PROTOCOL>
environment variable.

If a value is not set in the environment value, the default value will
depend on availability. If L<Google::ProtocolBuffer::Dynamic> is installed,
the protocol will default to "http/protobuf". Otherwise the exporter will
fall back to "http/json", using whatever encoding back-end is provided by
L<JSON::MaybeXS>.

If the value is set to a value other than the ones laid out above,
construction will throw an L<OpenTelemetry::X::Unsupported> exception.

=back

=head1 METRICS

This exporter generates a number of metrics to keep track of its regular
operation. At the time of writing, these metrics are non-standard, but their
inclusion in the standard
L<is being discussed|https://github.com/open-telemetry/semantic-conventions/issues/83>.

=over

=item C<otel.otlp_exporter.failure>

Incremented every time an error is encountered during export.

Reported with the following attributes:

=over

=item reason

=over

=item C<timeout>

The connection to the collector timed out.

=item C<socket_error>

There was a socket-related error while sending the data to the collector.
This could be that the socket couldn't be opened, or closed, or written
to, or otherwise properly configured.

=item C<ssl_error>

There was an error either establishing an SSL connection, or terminating a
previous SSL connection.

=item C<eof_error>

There was an unexpected end of stream.

=item C<parse_error>

There was an error parsing the URL to send the exported data to.

=item C<zlib_error>

An error was encountered when compressing payload.

=item HTTP status code

An error was encountered when calling the export endpoint. The reason will
be set to the non-successful numeric status code received from the server.

=back

=back

=item C<otel.otlp_exporter.message.compressed_size>

Set to the size of the request content after compression is done. This is
not sent if no compression is done.

=item C<otel.otlp_exporter.message.uncompressed_size>

Set to the size of the request content before compression is done.

=item C<otel.otlp_exporter.request_duration>

Set to the number of seconds, as a fraction, that the request took to
complete. It is set with the following attributes:

=over

=item C<status>

Set to the HTTP status code of the response.

=back

=back

=head1 SEE ALSO

=over

=item L<Compress::Zlib>

=item L<Google::ProtocolBuffer::Dynamic>

=item L<JSON::MaybeXS>

=item L<OpenTelemetry::Exporter>

=item L<OpenTelemetry::X::Unsupported>

=back

=head1 ACKNOWLEDGEMENTS

Special thanks to L<CV-Library Ltd.|https://cv-library.co.uk> for their
support in the development of this library.

=head1 COPYRIGHT AND LICENSE

This software is copyright (c) 2023 by José Joaquín Atria.

This is free software; you can redistribute it and/or modify it under the same
terms as the Perl 5 programming language system itself.
